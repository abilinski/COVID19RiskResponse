"0",""
"0","# library"
"0","library(here)"
"0",""
"0","# source global options"
"0","source(here(""global_options.R""))"
"0",""
"0","# set working directory"
"0","setwd(here(""0 - Data""))"
"0","load(""summary_extract2021-02-06.RData"")"
"0",""
"0","# state names + abbreviations + populations"
"0","pop = read.csv(""population.csv"")"
"0",""
"0","# load and process case data"
"0","data <- read.csv(""all-states-history2.csv"") %>% left_join(pop, c(""state"" = ""State"")) %>%"
"0","  mutate(date_cleaned = as.Date(as.character(date), format = ""%Y-%m-%d""),"
"0","         week = isoweek(date_cleaned)) %>%"
"0","  group_by(week) %>% mutate(date.temp = max(date_cleaned)) %>% ungroup() %>%"
"0","  dplyr::group_by(state, region, StateName, week, date.temp) %>% "
"0","  dplyr::summarize(cases = sum(positiveIncrease), deaths = sum(deathIncrease), hosp = sum(hospitalizedIncrease),"
"0","            perc_pos = sum(positiveIncrease)/sum(positiveIncrease + negativeIncrease),"
"0","            cases100K = cases/Population[1]*100000, deaths100K = deaths/Population[1]*100000, hosp100K = hosp/Population[1]*100000,"
"0","            tests = sum(positiveIncrease + negativeIncrease), tests_prop = tests/Population[1]) %>%"
"0","  gather(var, value, cases, deaths, hosp, perc_pos, cases100K, deaths100K, hosp100K, tests, tests_prop) %>%"
"0","  group_by(state, region, var) %>% mutate("
"0","    value = ifelse(value<0, 0, value),"
"0","    lag1 = lag(value, 1),"
"0","                                           lag2 = lag(value, 2),"
"0","                                           chg = value - lag1,"
"0","                                           perc_chg = (value - lag1)/lag1) %>%"
"0","  gather(var2, value2, value, lag1, lag2, chg, perc_chg) %>% mutate(ind = paste(var, var2, sep = ""_"")) %>%"
"0","  ungroup() %>% dplyr::select(-var, -var2) %>%"
"0","  spread(ind, value2) %>% group_by(state, region) %>% "
"0","  mutate(max = max(cases100K_value, na.rm = T),"
"0","         max.week = week[cases100K_value==max],"
"0","         max.date = date.temp[cases100K_value==max],"
"0",""
"0","         peak.time = ifelse(max.date < as.Date(""2020-07-01""), ""Spring"", ""Summer""),"
"0","         peak.time = ifelse(max.date > as.Date(""2020-08-15""), ""Increasing"", peak.time),"
"0","         "
"0","         min.summer = min(cases100K_value[date.temp>""2020-05-15"" & date.temp<""2020-08-01""]),"
"0","         min.week = week[cases100K_value==min.summer],"
"0","         max.summer = max(cases100K_value[date.temp> ""2020-07-01""]),"
"0","         "
"0","         weeks.since.peak = week - max.week,"
"0","         weeks.since.min = week - min.week"
"0","         "
"0","         ) %>% ungroup() "
"0",""
"0","data2 = data %>% group_by(state) %>% "
"0","  summarize(sum1 = sum(cases100K_value[date.temp>=""2020-03-01"" & date.temp<""2020-05-31""]),"
"0","            sum2 = sum(cases100K_value[date.temp>=""2020-07-01"" & date.temp<""2020-08-31""]),"
"0","            sum3 = sum(cases100K_value[date.temp>=""2020-09-01"" & date.temp<""2020-10-31""]))"
"0",""
"0","spring = unlist(data2 %>% arrange(-sum1) %>% dplyr::select(state) %>% filter(state!=""LA""))[1:10]"
"0","summer = unlist(data2 %>% arrange(-sum2) %>% dplyr::select(state) %>% filter(state!=""LA""))[1:10]"
"0","fall = unlist(data2 %>% arrange(-sum3) %>% dplyr::select(state))[1:10]"
"0",""
"0","US_pop = 328200000"
"0","national <- read.csv(""all-states-history2.csv"") %>% "
"0","  mutate(date_cleaned = as.Date(as.character(date), format = ""%Y-%m-%d""),"
"0","         week = isoweek(date_cleaned)) %>% group_by(week) %>% "
"0","  summarize(cases = sum(positiveIncrease), deaths = sum(deathIncrease), hosp = sum(hospitalizedIncrease),"
"0","            perc_pos = sum(positiveIncrease)/sum(positiveIncrease + negativeIncrease),"
"0","            cases100K = cases/US_pop*100000, deaths100K = deaths/US_pop*100000, hosp100K = hosp/US_pop*100000, tests = sum(positiveIncrease + negativeIncrease)) %>%"
"0","  gather(var, value, cases, deaths, hosp, perc_pos, cases100K, deaths100K, hosp100K, tests) %>%"
"0","  group_by(var) %>% mutate(lag1 = lag(value, 1),"
"0","                                  lag2 = lag(value, 2),"
"0","                                  chg = value - lag1,"
"0","                                  perc_chg = (value - lag1)/lag1) %>%"
"0","  gather(var2, value2, value, lag1, lag2, chg, perc_chg) %>% mutate(ind = paste(""natl"", var, var2, sep = ""_"")) %>%"
"0","  ungroup() %>% select(-var, -var2) %>%"
"0","  spread(ind, value2)"
"0",""
"0","# merge data"
"0","all = h %>% filter(date>=""2020-05-15"" & date<=""2020-11-22"") %>%"
"0","  #left_join(data, c(""state_coded"" = ""StateName"", ""week"" = ""week"")) %>% "
"0","  left_join(data, c(""state_id"" = ""state"", ""week"" = ""week"")) %>% "
"0","  left_join(national, c(""week"" = ""week"")) %>% mutate(no_contacts = 1-contacts, people = 1-avoid_people, not_worry = 1-worried_sick, contacts_1 = 1-contacts_1, contacts_2 = 1-contacts_2)"
"2","Error: Problem with `mutate()` input `no_contacts`.
[31mx[39m object 'contacts' not found
[34mâ„¹[39m Input `no_contacts` is `1 - contacts`.
[34mâ„¹[39m The error occurred in group 1: week = 20.
"
